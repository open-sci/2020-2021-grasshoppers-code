<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="./css/neumorphism.css">
    <link rel="stylesheet" href="./css/custom.css">
    <title>DOI classes of errors vizualization</title>
</head>

<body>
    <main>
        <!-- Hero -->
        <section class="section section bg-soft pb-5 overflow-hidden z-2">
            <div class="container z-2">
                <div class="row justify-content-center text-center pt-6">
                    <div class="col-lg-8 col-xl-8">
                        <h1 class="display-2 mb-3">Visualizing DOIs classes of errors</h1>
                    </div>
                </div>
            </div>
        </section>
        <section>
            <div class="container">
                <h2>Barplot</h2>
                <div class="card bg-primary shadow-inset border-light p-5 mb-5" id="barChartContainer">
                    <div class="vizSelector" id="bcOrderSelector"></div>
                    <div class="viz" id="doiErrorsViz"></div>    
                </div>
                <h2>Treemap</h2>
                <div class="card bg-primary shadow-inset border-light p-5" id="treemapContainer">
                    <div class="viz" id="doiErrorsTreemap"></div>    
                </div>
            </div>        
        </section>
    </main>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/6.7.0/d3.min.js" integrity="sha512-cd6CHE+XWDQ33ElJqsi0MdNte3S+bQY819f7p3NUHgwQQLXSKjE4cPZTeGNI+vaxZynk1wVU3hoHmow3m089wA==" crossorigin="anonymous"></script>    
    <script>
        var margin_bc = { left: 245, right: 50, top: 100, bottom: 10 }
        var width_bc = $("#barChartContainer").width() - margin_bc.left - margin_bc.right
        var height_bc = $(document).height() / 1.8 - margin_bc.top - margin_bc.bottom

        pretty_labels = {
            "Invalid_DOI": "Number of invalid DOIs after cleaning",
            "Valid_DOI": "Number of valid DOIs after cleaning",
            "Already_valid": "Already valid DOIs",
            "Prefix_error": "Prefix errors",
            "Suffix_error": "Suffix errors",
            "Other-type_error": "Other-type errors"
        }

        // Create a select dropdown
        const bcOrderSelector = document.getElementById("bcOrderSelector");
        const leSelectItems = ["Descendingly", "Ascendingly"];
        // Create a drop down
        d3.select(bcOrderSelector)
            .append("span")
            .append("select")
            .attr("id", "bcSelection")
            .attr("class", "form-control")
            .attr("name", "tasks")
            .selectAll("option")
            .data(leSelectItems)
            .enter()
            .append("option")
            .attr("value", d => d)
            .text(d => d);

        // Hover info
        var tip = d3.select("body").append("div")
            .attr("class", "tooltip")
            .style("opacity", 0);

        let bcMouseOver = function (event, d) {
            d3.selectAll("rect")
                .transition()
                .duration(200)
                .style("opacity", .5)
            d3.select(this)
                .transition()
                .duration(200)
                .style("opacity", 1)
            tip.transition()
                .duration(200)
                .style("opacity", .9)
                .style("left", (event.pageX) + "px")
                .style("top", (event.pageY - 28) + "px");
            tip.html(function () {
                return `
                <strong>Measure</strong>: ${pretty_labels[d.measure]}<br/>
                <strong>Value</strong>: ${d.value}
                `
            })
        }

        let bcMouseLeave = function (event, d) {
            d3.selectAll("rect")
                .transition()
                .duration(200)
                .style("opacity", 1)
            tip.transition()
                .duration(500)
                .style("opacity", 0);
        }

        var margin_tm = { left: 0, right: 0, top: 0, bottom: 0 }
            width_tm = $("#treemapContainer").width() - margin_tm.left - margin_tm.right,
            height_tm = $(document).height() / 1.8 - margin_tm.top - margin_tm.bottom;

        var svg_tm = d3.select("#doiErrorsTreemap")
            .append("svg")
            .attr("width", width_tm + margin_tm.left + margin_tm.right)
            .attr("height", height_tm + margin_tm.top + margin_tm.bottom)
            .append("g")
            .attr("transform",
                "translate(" + margin_tm.left + "," + margin_tm.top + ")");

        let tmMouseOver = function (event, d) {
            d3.selectAll("rect")
                .transition()
                .duration(200)
                .style("opacity", .5)
            d3.select(this)
                .transition()
                .duration(200)
                .style("opacity", 1)
            tip.transition()
                .duration(200)
                .style("opacity", .9)
                .style("left", (event.pageX) + "px")
                .style("top", (event.pageY - 28) + "px");
            tip.html(function () {
                return `
                <strong>Measure</strong>: ${pretty_labels[d.data.measure]}<br/>
                <strong>Value</strong>: ${d.value}
                `
            })
        }

        let tmMouseLeave = function (event, d) {
            d3.selectAll("rect")
                .transition()
                .duration(200)
                .style("opacity", 1)
            tip.transition()
                .duration(500)
                .style("opacity", 0);
        }

        d3.csv("https://raw.githubusercontent.com/open-sci/2020-2021-grasshoppers-code/main/output.csv").then(data => {
            data = prepare_data_to_viz(data);
            data_to_bp = data.filter( el => el.measure !== "DOIs" ); 
            ////////////// Barplot visualization
            document.addEventListener("DOMContentLoaded", doiBarchart());
            function doiBarchart() {
                // Append SVG to this DIV
                const doiBarchartDIV = document.createElement("div");

                var g_doi = d3.select(doiBarchartDIV)
                    .append("svg")
                    .attr("preserveAspectRatio", "xMinYMin meet")
                    .attr("viewBox", `0 0 ${width_bc + margin_bc.left + margin_bc.right} ${height_bc + margin_bc.top + margin_bc.bottom}`)
                    .append("g")
                    .attr("transform", "translate(" + margin_bc.left + ", " + margin_bc.top + ")");

                var y = d3.scaleBand()
                    .domain(data_to_bp.map(d => {
                        return pretty_labels[d.measure]
                    }))
                    .range([0, height_bc])
                    .padding(.3);

                var x = d3.scaleLinear()
                    .domain([0, 
                        d3.max(data_to_bp, d => {
                            return +d.value
                        })
                    ])
                    .range([0, width_bc])

                color = d3.scaleOrdinal(d3.schemeCategory10);

                var yAxisCall = d3.axisLeft(y);
                g_doi.append("g")
                    .attr("class", "y-axis")
                    .style("font-size", "14px")
                    .call(yAxisCall)
                    .selectAll("text")
                    .attr("text-anchor", "end")

                var xAxisCall = d3.axisTop(x)
                    .tickFormat(d => {
                        return d
                    });
                g_doi.append("g")
                    .attr("class", "x-axis")
                    .style("font-size", "14px")
                    .call(xAxisCall);

                //Bars
                var rects = g_doi.selectAll(".rect")
                    .data(data_to_bp)
                    .enter()
                    .append("rect")
                    .attr("x", x(0))
                    .attr("y", function(d) { return y(pretty_labels[d.measure]); })
                    .attr("width", 0)
                    .attr("height", y.bandwidth() )
                    .attr("fill", function (d) { return color(d.value) })
                    .on("mouseover", bcMouseOver)
                    .on("mouseout", bcMouseLeave)
                    .transition()
                    .delay(function (d) { 
                        return Math.random() * 1000; 
                    })
                    .duration(1000)
                    .attr("x", x(0))
                    .attr("width", function (d) {
                        return x(d.value);
                    });

                // This code will redraw charts based on dropdown selection. 
                const showdoiBarchart = document.getElementById("doiErrorsViz");
                while (showdoiBarchart.firstChild) {
                    showdoiBarchart.firstChild.remove();
                }
                showdoiBarchart.appendChild(doiBarchartDIV);
            }

            // Chart changes based on drop down selection
            d3.select("#bcSelection").on("change", function () {
                const selectedOption = d3.select(this).node().value;
                if (selectedOption == "Ascendingly") {
                    data_to_bp.sort((a, b) => d3.ascending(+a.value, +b.value))
                } else if (selectedOption == "Descendingly") {
                    data_to_bp.sort((a, b) => d3.descending(+a.value, +b.value))
                }
                doiBarchart();
            });

            ////////////// Treemap visualization
            var root = d3.stratify()
                .id(function (d) {return d.measure })   
                .parentId(function (d) {return d.parent })   
                (data);
            root.sum(function (d) { return +d.value })   

            d3.treemap()
                .size([width_tm, height_tm])
                .padding(4)
                (root)

            svg_tm
                .selectAll("rect")
                .data(root.leaves())
                .enter()
                .append("rect")
                .attr('x', function (d) { return d.x0; })
                .attr('y', function (d) { return d.y0; })
                .attr('width', function (d) { return d.x1 - d.x0; })
                .attr('height', function (d) { return d.y1 - d.y0; })
                .style("stroke", "black")
                .style("fill", function(d){ 
                    console.log(d)
                    return color(d.data.value) 
                });

            svg_tm
                .selectAll("text")
                .data(root.leaves())
                .enter()
                .append("text")
                .attr("x", function (d) { return d.x0 + 10 })    // +10 to adjust position (more right)
                .attr("y", function (d) { return d.y0 + 30 })    // +20 to adjust position (lower)
                .text(function (d) { return pretty_labels[d.data.measure] })
                .attr("font-size", "20px")
                .attr("font-weight", "bold")
                .attr("fill", "black")
            
            svg_tm
                .selectAll("rect")
                .on("mouseover", tmMouseOver)
                .on("mouseout", tmMouseLeave)
        }).catch(error => {
            console.log(error);
        });

        function prepare_data_to_viz(d) {
                count_data = [
                    {
                        "measure": "DOIs",
                        "parent": "",
                        "value": 0
                    },
                    {
                        "measure": "Invalid_DOI",
                        "parent": "DOIs",
                        "value": d.length
                    },
                    {
                        "measure": "Valid_DOI",
                        "parent": "DOIs",
                        "value": 0
                    },
                    {
                        "measure": "Already_valid",
                        "parent": "DOIs",
                        "value": 0
                    },
                    {
                        "measure": "Prefix_error",
                        "parent": "DOIs",
                        "value": 0
                    },
                    {
                        "measure": "Suffix_error",
                        "parent": "DOIs",
                        "value": 0
                    },
                    {
                        "measure": "Other-type_error",
                        "parent": "DOIs",
                        "value": 0
                    }
                ]
                $.each(d, function(k, v){
                    $.each(v, function(k, v){
                        if (k == "Valid_DOI" && v != ""){
                            count_data.forEach(obj => {
                                if (obj.measure == k){
                                    obj.value += 1
                                } else if (obj.measure == "Invalid_DOI"){
                                    obj.value -= 1
                                }
                            })
                        } else if (k == "Already_valid" || k == "Prefix_error" || k == "Suffix_error" || k== "Other-type_error"){
                            count_data.forEach(obj => {
                                if (obj.measure == k){
                                    obj.value += +v
                                }
                            });
                        }
                    });
                });
                count_data.sort(function(a, b){return b.value - a.value})
                return count_data;
            }
    </script>
</body>

</html>